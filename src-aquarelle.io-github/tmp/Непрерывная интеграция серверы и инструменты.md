# Непрерывная интеграция: серверы и инструменты

Обучение использованию DevOps с помощью серверов и инструментов

Следуйте этому руководству по непрерывной интеграции, в котором используется Хадсон. Обязательно для всех, кто работает с CI.



![img](https://dz2cdn1.dzone.com/storage/rc-covers/4055328-refcard-cover87.png)



СЕКЦИЯ 1

## О непрерывной интеграции и DevOps

Непрерывная интеграция является одной из нескольких основных концепций, которые необходимо учитывать при реализации культуры DevOps внутри организации. Основные принципы реализации DevOps обобщены тем, что Джин Ким описывает как «Три способа». [ *1* ]Первым способом является переход к системному мышлению - это оценка производительности системы в целом. Обычно это связано с организационными изменениями на культурном уровне.

Второй способ, и то, что мы будем здесь фокусировать, включает усиление контуров обратной связи. *Второй способ - создать петли обратной связи справа налево. Цель практически любой инициативы по совершенствованию процесса состоит в том, чтобы сократить и усилить петли обратной связи, поэтому необходимые корректировки могут быть постоянно выполнены.*

> *Результатами второго пути являются понимание и реагирование на всех клиентов, внутреннее и внешнее, сокращение и усиление всех циклов обратной связи и внедрение знаний там, где это нам необходимо.*

> \- Джин Ким Три способа: принципы, лежащие в основе DevOps

Непрерывная интеграция помогает выполнить этот второй принцип. Постоянный обзор, сбор и проверка программного обеспечения позволяет нам как можно скорее решить потенциальные проблемы. Это также способствует прозрачности, так как все члены команды имеют доступ к аналитическим артефактам, созданным системой.

РАЗДЕЛ 2

## Инструмент CI

Существует множество инструментов, которые можно использовать для внедрения системы непрерывной интеграции. Для целей этой справочной карты мы сосредоточим внимание на следующем:

| Инструмент  | Описание                                 |
| ----------- | ---------------------------------------- |
| Apache Mave | N 3.3.3 Apache Maven - это инструмент управления проектами и программного обеспечения. Основываясь на концепции объектной модели проекта (POM), Maven может управлять сборкой, созданием отчетов и документацией из центральной части информации. |
| Git 2.5.5   | Система управления версиями, которая широко используется для разработки программного обеспечения и других задач контроля версий. Это распределенная система контроля версий с акцентом на скорость, целостность данных и поддержку распределенных нелинейных рабочих процессов. |
| Jenkins 2.0 | Jenkins - это сервер автоматизации с открытым исходным кодом с уникальной экосистемой плагинов для поддержки практически каждого инструмента в составе ваших конвейеров доставки. Является ли ваша цель непрерывной интеграцией, непрерывной доставкой или чем-то еще, Дженкинс может помочь ее автоматизировать. Jenkins 2.0 обеспечивает встроенную поддержку доставки трубопроводов, улучшенную удобство использования и полную обратную совместимость. |
| SonarQube 5 | .5 Открытая платформа для управления качеством кода, включая статический анализ кода. |
| Gerrit 2.12 | .x Предоставляет обзор веб-кода и управление репозиториями для системы управления версиями Git. |
| SonaType Ne | Xus 3.0.x Репозиторий для артефактов Java (например, файлы JAR и WAR). Версия 3 обеспечивает дополнительную поддержку файлов изображений в формате docker-формата, NPM (менеджер пакетов узлов), Bower (HTML, CSS, Javascript-репозиторий) и NuGet (менеджер пакетов Microsoft .NET) |

РАЗДЕЛ 3

## Демо-линия CI

Графическое представление конвейера CI доступно на [*странице https://raw.githubusercontent.com/kharyam/dzone-ci-demo-app/master/images/ci-pipeline-overview.png*](https://raw.githubusercontent.com/kharyam/dzone-ci-demo-app/master/images/ci-pipeline-overview.png) Конвейер состоит из следующих шагов:

1. Код разработчика клонирования из авторитетного репозитория Git, управляемого Gerrit
2. Разработчик перенаправляет изменение кода в ожидающий репозиторий изменений, управляемый Gerrit
3. Ведущий группы рассматривает изменение кода в ожидающем изменения хранилище
4. Руководитель команды утверждает изменения кода в репозитории ожидающих изменений
5. Руководитель команды представляет изменения кода в авторитетный репозиторий Git
6. Gerrit запускает трубопровод Jenkins CI через смененный Git крюк.
7. Выполняется этап проверки трубопровода
8. Этап Checkout клонирует исходный код из авторитетного репозитория git
9. На сцене Build выполняется сборка кода maven
10. Этап анализа называет SonarQube для выполнения статического анализа кода
11. Этап архива загружает файл WAR в репозиторий Nexus. Он также архивирует результаты единичных тестов в Jenkins
12. Этап «Развертывание до разработки» развертывает WAR с Nexus на серверы разработки *
13. При разрешенном разрешении на этапе развертывания до тестирования развертывается WAR на тестовых серверах *
14. После официального утверждения на этапе развертывания на производство развертывается WAR на производственных серверах *

* *Обратите внимание, что последние три шага считаются частью процесса непрерывного развертывания (CD), однако это также может быть обработано конвейером Jenkins. Эти шаги - это просто заполнители, которые могут быть реализованы, если CD желателен.*

*Существует два варианта продолжения работы с этой справочной картой. Инструменты можно установить вручную в соответствии с разделом « \**Ручная установка инструментов сервера CI»** или вы можете использовать примерный образ контейнера в формате docker, описанный в разделе « **Использование контейнера Contier Image CI Server, оформленного в докере»***

РАЗДЕЛ 4

## Использование CI-сервера Docker-Formatted Container Image

Для конфигурации, описанной в этой справочной карте, было создано изображение контейнера в формате докере. См. [*Https://hub.docker.com/r/kharyam/ciserver/*](https://hub.docker.com/r/kharyam/ciserver/)

Более подробную информацию о Docker см. В разделе «Начало работы с Docker Refcard» ( [*https://dzone.com/storage/assets/572027-rc221-docker.pdf*](https://dzone.com/storage/assets/572027-rc221-docker.pdf) )

Для запуска образа контейнера выполните следующие действия. 1. Потяните изображение контейнера

`docker pull kharyam/ciserver`

1. Запустить изображение контейнера

 `*$ docker run -d -p 8081-8084:8081-8084 -p 29418:29418 -p 40396:40396 --name=ciserver kharyam/ciserver:latesta75ac65d97ad5c.... (1)*` 

**1** Это идентификатор контейнера, запускаемого двигателем докеров

Первоначальный вход в Jenkins потребует пароль, напечатанный, когда первоначально появляется Jenkins. Вы можете ввести следующую команду для получения этого пароля.

 `*$ docker logs ciserver 2>&1 | grep -A1 "Please use"`

`Please use the following password to proceed to installation: 4a9bb0ea09cb4f21aa8d9fc506661a80 (1)*` 

**1** Используйте этот пароль для первоначального входа Jenkins, описанного в разделе **Установка и настройка Jenkins**

Перейдите к разделу « **Ручная установка инструментов сервера CI»** , пропустив указанные шаги как ненужные для изображений контейнеров.

РАЗДЕЛ 5

## Ручная установка инструментов сервера CI

Здесь мы описываем, как устанавливать и настраивать указанные выше средства на сервере linux. После завершения вы сможете протестировать непрерывный поток интеграции. Эти шаги были протестированы на Fedora 23, но могут быть легко изменены для других дистрибутивов Linux.

**Примечание** . Конфигурация, описанная здесь, предназначена для демонстрации / обучения и не предназначена для использования в производстве. Например, мы будем использовать встроенные базы данных для Gerrit и SonarQube, в то время как в производстве вы будете использовать специальную базу данных, такую как PostgreSql или MySQL.

Выберите место для установки программного обеспечения и информации о конфигурации для сервера CI, например / opt / ciserver. Мы будем ссылаться на это местоположение как $ CI_HOME

### **Установка и настройка Java, Maven и Git**

**Примечание.** Вы можете пропустить этот раздел, если используете изображение контейнера

**Примечание.** Если вы используете Red Hat Enterprise Linux или CentOS, замените команду dnf на yum

1. Установите Java, maven и git:

`$ sudo dnf install java-1.8.0-openjdk-devel maven git gitweb*`

### **Установка и настройка Nexus**

**Примечание.** Если вы используете изображение контейнера, вы можете перейти к шагу 4. Nexus может занять несколько минут, чтобы начать первый раз.

1. Скачать Nexus 3.0.x [*http://www.sonatype.com/download-oss-sonatype*](http://www.sonatype.com/download-oss-sonatype)
2. Извлечь архив:

`$ tar -xf nexus-3.0.0-03-unix.tar.gz -C $CI_HOME*`

**Примечание.** По умолчанию Nexus будет работать на порту 8081. Это можно изменить, обновив *$ CI_HOME / nexus-3.0.0-03 / etc / org.sonatype.nexus.cfg*

1. Запустите Nexus, используя конфигурацию по умолчанию:

`$ cd $CI_HOME/nexus-3.0.0-03/bin $ ./nexus start Starting Nexus*`

1. Откройте браузер на [*http: // localhost: 8081,*](http://localhost:8081/) и вы увидите экран приветствия Nexus. Войдите как admin с паролем admin123
2. Вы можете изменить пароль администратора, щелкнув имя пользователя Admin в меню заголовка, затем выбрав «Изменить пароль»

Теперь мы создадим новую роль в Nexus, которая имеет возможность администрировать репозитории релиза и моментальных снимков. 1. Щелкните значок шестеренки, затем выберите «Роли» в разделе «Безопасность» в левой части экрана и нажмите кнопку «Создать роль → Неактивная роль»

1. Введите следующие значения: Идентификатор роли: nx-mvn-adminRole Имя: Nexus Maven AdminPrivileges: nx-repository-admin-maven2-maven-releases- *, nx-repository-admin-maven2-maven-snapshots- *, nx-repository -view-maven2-maven-релизы- *, nx-repository-view-maven2-maven-snapshots- *
2. Нажмите кнопку «Создать роль»

Затем мы создадим учетную запись пользователя Jenkins, которая позволит нашему конвейеру CI загружать артефакты в хранилище Nexus. 1. Щелкните значок шестеренки и выберите «Пользователи» в разделе «Безопасность» в левой части экрана и нажмите кнопку «Создать пользователя»

1. Введите следующие значения:

| **поле**           | **Стоимость**                        |
| ------------------ | ------------------------------------ |
| Я БЫ               | Дженкинс                             |
| Имя                | Дженкинс                             |
| Фамилия            | Deployer                             |
| Эл. адрес          | jenkins@nowhere.com                  |
| пароль             | jenkins123                           |
| Подтвердите Пароль | jenkins123                           |
| Положение дел      | активный                             |
| Роли               | Руководство пользователя Nexus Maven |

1. ​

2. Нажмите кнопку «Создать пользователя»

### **Установка и настройка Gerrit**

**Примечание.** Вы можете пропустить этот раздел, если используете изображение контейнера

1. Загрузить Gerrit 2.12.x - [*https://Gerrit-releases.storage.googleapis.com/index.html*](https://gerrit-releases.storage.googleapis.com/index.html)
2. Поместите файл WAR в $ CI_HOME
3. Инициализировать Gerrit:

`$ java -jar Gerrit.war init --batch -d $CI_HOME/Gerrit*`

1. Добавьте в конец $ CI_HOME / Gerrit / etc / Gerrit.config следующее:

`[gitweb] cgi = /var/www/git/gitweb.cgi*`

1. Измените порт Gerrit работает с 8080 по 8082. Отредактируйте $ CI_HOME / Gerrit / etc / Gerrit.config и замените все вхождения 8080 на 8082
2. Измените тип аутентификации с OPENID на DEVELOPMENT_BECOME_ANY_ACCOUNT. Измените $ CI_HOME / Gerrit / etc / Gerrit.config и замените все вхождения OPENID на DEVELOPMENT_BECOME_ANY_ACCOUNT

**Примечание.** Gerrit поддерживает множество схем аутентификации, включая OPENID и LDAP. Для наших демонстрационных целей мы включим простую схему проверки подлинности, **не предназначенную для использования в производстве** . Для получения дополнительной информации о поддержке аутентификации Gerrit см. [*Https://Gerrit-review.googlesource.com/Documentation/config-Gerrit.html#auth*](https://gerrit-review.googlesource.com/Documentation/config-Gerrit.html#auth) .

1. Загрузите последнюю версию JAR для безопасного замка безопасности здесь [*https://www.bouncycastle.org/latest_releases.html*](https://www.bouncycastle.org/latest_releases.html)
2. Скопируйте файл JAR в $ CI_HOME / Gerrit / lib
3. Перезапустить Gerrit

`$ $CI_HOME/Gerrit/bin/Gerrit.sh restart*`

1. Теперь вы можете получить доступ к домашней странице Gerrit через [http: // localhost: 8082](http://localhost:8082/)

### **Установка и настройка SonarQube**

**Примечание.** Вы можете пропустить этот раздел, если используете изображение контейнера. Просто обратите внимание, что имя пользователя по умолчанию - admin, с паролем admin

1. Скачать SonarQube - [*http://www.sonarqube.org/downloads/*](http://www.sonarqube.org/downloads/)

`$ unzip sonarqube-5.5.zip -d $CI_HOMEsonar.web.port=8084 $ echo "sonar.web.port=8084" &gt;&gt; $CI_HOME/sonarqube-5.5/conf/sonar.properties $ cd $CI_HOME/sonarqube-5.5/bin/linux-x86-64 $ ./sonar.sh start*`

1. Теперь вы можете войти в веб-консоль, указав свой браузер на http: // localhost: 8084 Войти как admin с паролем admin

### **Установка и настройка Jenkins**

**Примечание.** Если вы используете изображение контейнера, вы можете перейти к шагу 3

1. Загрузить Jenkins - [*https://Jenkins.io/2.0/*](https://jenkins.io/2.0/)

`$ mv Jenkins.war $CI_HOME*`

1. Запуск Jenkins на порт 8083 и отметьте пароль администратора:

 `$ java -jar Jenkins.war --httpPort=8083 *... Jenkins initial setup is required. An admin user has been created and a password generated. Please use the following password to proceed to installation:`

`112233445566778899aabbccddeeff11 (1)`

`...*` 

**1** Начальный пароль Дженкинса

1. Войдите в Jenkins через http: // localhost: 8083, используя пароль, указанный выше. Если вы используете изображение контейнера, используйте пароль, который был предоставлен командой docker logs.
2. Выберите опцию Установить предлагаемые плагины
3. Заполните запрошенную информацию, чтобы создать учетную запись администратора. Используйте администратор admin и пароль администратора. Нажмите «Сохранить» и «Готово», затем нажмите «Начать» с помощью Jenkins
4. Теперь вам будет представлена главная страница Jenkins

Теперь вы можете перейти к **настройке конвейера CI**

РАЗДЕЛ 6

## Настройка конвейера CI

### **Настроить Gerrit**

Мы собираемся создать две учетные записи пользователей в Gerrit. Один из них представляет собой команду разработчиков, а другой - разработчика. 1. Подключитесь к Gerrit через http: // localhost: 8082 / login

1. Выберите кнопку «Новая учетная запись» под заголовком «Регистр»
2. Введите команду для полного имени и нажмите кнопку «Сохранить изменения»
3. Введите команду для имени пользователя и нажмите кнопку «Выбрать имя» (нажмите «ОК» для подтверждения)
4. Вставьте открытый ключ ssh, который вы используете для Git (например, ~ / .ssh / id_rsa.pub), в текстовое поле «Добавить открытый SSH» и нажмите кнопку «Добавить»
5. Если вы используете образ контейнера, вы можете создать пару ssh-ключей, выполнив следующие шаги:
6. Войдите в свой контейнер

`$ docker exec -it ciserver /bin/bash*`

1. Создание пары ключей

`$ ssh-keygen Generating public/private rsa key pair. Enter file in which to save the key (/opt/ci-server/.ssh/id_rsa): **(1)** Created directory '/opt/ci-server/.ssh'. Enter passphrase (empty for no passphrase): **(1)** Enter same passphrase again: **(1)** Your identification has been saved in /opt/ci-server/.ssh/id_rsa. Your public key has been saved in /opt/ci-server/.ssh/id_rsa.pub. The key fingerprint is: SHA256:ApTkVs+jY/N85pLY4WTKOJ1n2SOojs7B8Fi6F4/wsOg ci-server@2cdd3e3d74de The keys randomart image is: +---[RSA 2048]----+ | .o.. | | o.. | | + + | | . . . . | |. . * S | | | |+=++ + Xo=o | | | |oE+.oo o o.. | +----[SHA256]-----+*`

**1** Нажмите «Ввод» при появлении запроса

1. Скопируйте открытый ключ, созданный в /opt/ci-server/.ssh/id_rsa.pub
2. Нажмите ссылку Продолжить в нижней части страницы. Поскольку это первый пользователь, которого мы создали в Gerrit, пользователю автоматически предоставляются права администратора.
3. Вернитесь к http: // localhost: 8082 / login и снова нажмите кнопку «Новая учетная запись» под заголовком «Регистр»
4. Введите Team Developer для полного имени и нажмите кнопку «Сохранить изменения»
5. Введите teamdeveloper для имени пользователя и нажмите кнопку «Выбрать имя» (нажмите «ОК» для подтверждения)
6. Нажмите кнопку «Зарегистрировать новую электронную почту ..», введите адрес электронной почты, который у вас есть (или будет иметь) в вашем .gitconfig. Нажмите Зарегистрироваться
7. Вставьте открытый ключ ssh, который вы используете для Git (например, ~ / .ssh / id_rsa.pub) в текстовое поле «Добавить открытый SSH» и нажмите кнопку «Добавить». Используйте тот же открытый ключ, который использовался для пользователя команды.
8. Нажмите ссылку Продолжить в нижней части страницы.

### **Настройка Maven для SonarQube**

**Примечание.** Вы можете пропустить этот раздел, если используете изображение контейнера

Сделайте резервную копию /usr/share/maven/conf/settings.xml и используйте вместо этого следующее. Если вы используете изображение контейнера, этот файл уже установлен.

```
<? Xml  version = "1.0"  encoding = "UTF-8" ?>
```

```
< Настройки >
```

```

```

```
  < Серверы >
```

```
    < Сервер > ( 1 )
```

```
      < Id > внутренний . Репо </ id >
```

```
      < Имя пользователя > jenkins </ username >
```

```
      < Пароль > jenkins123 </ password >
```

```
    </ Server >
```

```
  </ Servers >
```

```

```

```
  < PluginGroups > ( 2 )
```

```
    < PluginGroup > org . Sonarsource . Сканер . Maven </ pluginGroup >
```

```
  </ PluginGroups >
```

```
  < Профили >
```

```
    < Профиль >
```

```
      < Id > сонар </ id >
```

```
      < Активация >
```

```
        < ActiveByDefault > true </ activeByDefault >
```

```
      </ Activation >
```

```
      < Свойства >
```

```
        < Сонар . Хост . Url >
```

```
          Http : // localhost: 8084 (3)
```

```
        </ Sonar . Хост . Url >
```

```
      </ Properties >
```

```
    </ Profile >
```

```
  </ Profiles >
```

```
</ Settings >
```

**1** Учетные данные для нажатия артефактов в Nexus. Примечание. Maven также поддерживает шифрование паролей - *http://maven.apache.org/guides/mini/guide-encryption.html*
**2** Плагин Sonar для анализа статического кода 
**3** URL-адрес сервера сонара

### **Настроить Дженкинса**

**Примечание.** Вам необходимо выполнить эти шаги, даже если вы используете изображение контейнера.

### **Настройка Maven**

\1. Вернитесь на консоль Jenkins ( [*http: // localhost: 8083*](http://localhost:8083/) ) и войдите в систему как администратор

1. Нажмите ссылку «Управление дженкинсами» слева
2. Нажмите «Глобальная настройка инструмента»
3. В самом низу нажмите Добавить Maven. Для имени укажите M3. Отменить выбор Установить автоматически и установить значение MAVEN_HOME в / usr / share / maven
4. Нажмите кнопку «Сохранить» в нижней части страницы.

### **Установка дополнительных плагинов**

\1. На странице «Управление пользователями Jenkins» выберите «Управление плагинами».

1. Перейдите на вкладку Доступные и введите sonarqube в фильтр поиска.
2. Установите флажок рядом с плагином SonarQube и нажмите кнопку «Установить без перезагрузки»
3. Повторите предыдущие шаги, чтобы установить плагин Sidebar Link, указав ссылку боковой панели в поисковом фильтре

### **Установить JAVA_HOME**

\1. Перейдите в раздел Управление Jenkins → Конфигурирование системы

1. В разделе «Глобальные свойства» выберите «Переменные среды»
2. Введите JAVA_HOME для имени и /usr/lib/jvm/java-1.8.0 в качестве значения
3. Нажмите кнопку «Сохранить» в нижней части страницы.

### **Добавить ссылки на SonarQube, Nexus и Gerrit (необязательно)**

Эти шаги создадут ссылки на главной странице Jenkins на страницы Nexus, Gerrit и SonarQube. 1. Перейдите в раздел Управление Jenkins → Конфигурирование системы

1. В разделе Дополнительные ссылки боковой панели введите следующую информацию:

| **поле**         | **Стоимость**            |
| ---------------- | ------------------------ |
| URL ссылки       | HTTP: // локальный: 8084 |
| Текст ссылки     | SonarQube                |
| Ссылка на иконку | gear.png                 |

1. ​

2. Нажмите кнопку «Добавить ссылку» и введите следующие значения для Nexus

| **поле**         | **Стоимость**            |
| ---------------- | ------------------------ |
| URL ссылки       | HTTP: // локальный: 8081 |
| Текст ссылки     | нексус                   |
| Ссылка на иконку | gear.png                 |

1. ​

2. Нажмите кнопку «Добавить ссылку» и введите следующие значения для Gerrit

| **поле**         | **Стоимость**            |
| ---------------- | ------------------------ |
| URL ссылки       | HTTP: // локальный: 8082 |
| Текст ссылки     | Геррит                   |
| Ссылка на иконку | gear.png                 |

1. ​

2. Нажмите кнопку «Сохранить» в нижней части экрана.

### **Push-код для Gerrit**

Эти направления будут относиться к $ GIT_HOME как каталог, в котором хранятся ваши проекты git, например ~ / git. С помощью этих шагов мы создадим новый проект в Gerrit, засеяем его исходным кодом из существующего репозитория GitHub.

**Примечание.** Если вы используете изображение контейнера, вы можете выполнить эти действия в контейнере. Войдите в контейнер и создайте каталог git в домашнем каталоге mkdir ~ / git && cd ~ / git

1. Скройте демо-приложение ( [*https://github.com/kharyam/dzone-ci-demo-app*](https://github.com/kharyam/dzone-ci-demo-app) ) из GitHub и удалите каталог .git

`$ cd $GIT_HOME $ git clone https://github.com/kharyam/dzone-ci-demo-app.git $ rm -fr $GIT_HOME/dzone-ci-demo-app/*.git`

1. Создайте новый проект под названием Demo в Gerrit как пользователь команды

`$ ssh -p 29418 teamlead@localhost gerrit create-project Demo --empty-commit*`

1. Клонировать новый проект как пользователь teamdeveloper 

```
$ cd $GIT_HOME 
$ git clone ssh://teamdeveloper@localhost:29418/Demo.git
```

1. Перенесите файлы из проекта github в проект Gerrit

`$ mv $GIT_HOME/dzone-ci-demo-app/* $GIT_HOME/Demo $ mv $GIT_HOME/dzone-ci-demo-app/.gitignore $GIT_HOME/*Demo`

1. Установите крючок фиксации Gerrit Git. Этот hook добавит идентификатор изменения в сообщение фиксации, которое требуется Gerrit. Для получения дополнительной информации см. [*Https://Gerrit-review.googlesource.com/Documentation/user-changeid.html*](https://gerrit-review.googlesource.com/Documentation/user-changeid.html)

`$ cd $GIT_HOME/Demo $ gitdir=$(git rev-parse --git-dir); scp -p -P 29418 teamdeveloper@localhost:hooks/commit-msg ${gitdir}/h*ooks/`

1. Зафиксируйте и нажмите код на Gerrit

**Примечание.** Если вы запускаете это в контейнере, *сначала* выполните следующие *команды:*

```
$  Git  config  - глобальный  пользователь . Имя  "teamdeveloper"
```

```

```

```
$  Git  config  - глобальный  пользователь . Email  "email@somewhere.com" ( 1 )
```

```
$  Cd  $ GIT_HOME / Демо
```

```
$  Git  add . ( 1 )
```

```
$  Git  commit  - am  "Initial commit" ( 2 )
```

```
$  Git  push  origin  HEAD : refs / for / master ( 3 )
```

```

```

```
Подсчет  объектов : 20 , сделано .
```

```
Дельта  сжатие ,  используя  до  до  8  нитей .
```

```
Сжатие  объектов : 100 % ( 11 / 11 ), сделано .
```

```
Запись  объектов : 100 % ( 20 / 20 ), 3,32  KiB  |  0  байт / с , сделано .
```

```
Всего  20 ( дельта  0 ), повторно используется  0 ( дельта  0 )
```

```
Удаленный : Обработка  изменений : новая : 1 , refs : 1 , done
```

```
Удаленный :
```

```
Remote : Новые  изменения :
```

```
Remote :    http : // localhost: 8082/6 Исходное коммитирование
```

```
Удаленный :
```

```
В  ssh : //teamdeveloper@localhost:29418/Demo.git
```

**1** Рекурсивно сценируйте все файлы в локальный репозиторий Git **2** Зафиксируйте все вновь добавленные / измененные файлы в локальном репозитории Git **3** Нажмите фиксацию в удаленный репозиторий Gerrit. HEAD: refs / for / master - это специальная ссылка Git, используемая Gerrit для изменения изменений для проверки до того, как они будут доступны в авторитетном репозитории Git.

1. Теперь, если вы перейдете к Open Reviews в Gerrit (http: // localhost: 8082 / # / q / status: open), вы увидите ожидающий просмотр этого первоначального коммита.

### **Создание проекта Дженкинса**

Здесь мы создадим новый проект Jenkins, который развернет наш Continuous Integration Pipeline. Сам трубопровод определен в файле Jenkins нашего образца проекта.

\1. Войдите в консоль Jenkins ( [*http: // localhost: 8083 /*](http://localhost:8083/) ) как пользователь admin

1. Нажмите ссылку «Создать элемент»
2. Введите название проекта CI Demo, выберите опцию Pipeline, затем нажмите кнопку OK
3. В Build Triggers выберите Trigger builds удаленно (например, из скриптов). Для токена аутентификации введите super_secret_build_token

**Примечание.** Это позволит нам инициировать сборку, выполнив HTTP- [*доступ*](http://localhost:8083/job/CI%20Demo/build?token=super_secret_build_token) по URL-адресу [*http: // localhost: 8083 / job / CI% 20Demo / build? Token = super_secret_build_token*](http://localhost:8083/job/CI%20Demo/build?token=super_secret_build_token) Мы будем использовать это, чтобы создать крючок Git в Gerrit, который будет запускать Сборка Jenkins, когда код успешно проверен экспертом.

1. В разделе «Конвейер» установите сценарий «Определение в трубопровод» из SCM
2. Установите SCM в Git и введите URL-адрес репозитория Gerrit - http: // localhost: 8082 / p / Demo.git
3. Нажмите кнопку «Сохранить»

РАЗДЕЛ 7

## Определение трубопровода

Чтобы узнать больше о плагине Jenkins Pipeline (ранее известном как плагин Jenkins Workflow), см. [*Https://dzone.com/refcardz/continuous-delivery-with-Jenkins-workflow*](https://dzone.com/refcardz/continuous-delivery-with-Jenkins-workflow)

```
Узел {( 1 )
```

```
   // Отметьте код проверки «stage» ....
```

```
   Этап  «Оформить заказ» ( 2 )
```

```

```

```
   // Получить последний код из Gerrit
```

```
   Git  url : 'http: // localhost: 8082 / p / Demo.git' ( 3 )
```

```

```

```
   // Получить инструмент maven.
```

```
   Def  mvnHome  =  инструмент  'M3' ( 4 )
```

```

```

```
   Этап  'Build'
```

```

```

```
   // Обновляем версию в pom, чтобы соответствовать номеру сборки Jenkins. (5)
```

```
   Sh  "$ {mvnHome} / bin / mvn: set -DnewVersion = $ {env.BUILD_NUMBER} -DallowSnapshots = true"
```

```

```

```
   // Запустите maven build
```

```
   Sh  "$ {mvnHome} / bin / mvn чистый пакет"
```

```

```

```
   Этап  «Анализ»
```

```
   Sh  "$ {mvnHome} / bin / mvn сонар: сонар" ( 6 )
```

```

```

```
   Этап  'Архив'
```

```

```

```
   // Архив артефактов в Дженкинсе (7)
```

```
   Step ([ $ class : «ArtifactArchiver» , артефакты : «** / target / *. Jar, ** / target / *. War ' , fingerprint : true ])
```

```

```

```
   // Архив результатов тестирования. (8)
```

```
   шаг ([ $ класс : 'JUnitResultArchiver' , TestResults : '** / цель / Surefire-отчеты / TEST - * XML' ])
```

```

```

```
   // Развертывание артефактов в Nexus (9)
```

```
   Sh  "$ {mvnHome} / bin / mvn deploy"
```

```

```

```

```

```
   Этап  параллелизма : 1 , имя : «Развертывание в развитие» ( 10 )
```

```
   Echo  'Моделирование развертывания в среде разработки'
```

```
   Echo  "Загрузка файла WAR из http: // localhost: 8081 / репозиторий / maven-релизы / org / example / cisampleapp / $ {env.BUILD_NUMBER} / cisampleapp- $ {env.BUILD_NUMBER} .war"
```

```
   Echo  'Развертывание WAR-файла на сервер (ы) разработки'
```

```
   Сон  2
```

```

```

```

```

```
   Этап  параллелизма : 1 , имя : 'Развертывание для тестирования'
```

```
   Таймаут ( время : 7 , единица измерения : «ДНИ» ) {( 11 )
```

```
     Входное  сообщение : «Вы хотите развернуть тест?» , Податель : 'admin' ( 12 )
```

```
    }
```

```
   Echo  'Имитация развертывания в тестовой среде'
```

```
   Echo  "Загрузка файла WAR из http: // localhost: 8081 / репозиторий / maven-релизы / org / example / cisampleapp / $ {env.BUILD_NUMBER} / cisampleapp- $ {env.BUILD_NUMBER} .war"
```

```
   Echo  'Развертывание WAR-файла для тестирования серверов (ов)
```

```
   Спать  5
```

```

```

```

```

```
   Этап  параллелизма : 1 , имя : «Развернуть на производство»
```

```
   Тайм-аут ( время : 7 , единица измерения : «ДНИ» ) {
```

```
     Входное  сообщение : «Вы хотите развернуть в Production?» , Податель : 'admin'
```

```
    }
```

```
   Echo  'Моделирование развертывания в производственной среде'
```

```
   Echo  "Загрузка файла WAR из http: // localhost: 8081 / репозиторий / maven-релизы / org / example / cisampleapp / $ {env.BUILD_NUMBER} / cisampleapp- $ {env.BUILD_NUMBER} .war"
```

```
   Echo  'Развертывание WAR-файла на серверы (ы) производства'
```

```
   Спать  5
```

```

```

```
}
```

**1** Узел указывает, что содержащиеся шаги будут выполняться на узле Дженкинса. При желании можно указать метку узла, чтобы ограничить шаги для запуска определенного узла. 
**2** Определение первого этапа в конвейере, называемого Checkout. 
**3** Проверьте исходный код нашего репозитория Git. 
**4** Определите местоположение командной строки Maven из нашего ранее настроенного определения M3 в конфигурации Jenkins. 
**5** Перед запуском сборки используйте команду maven set: versions, чтобы обновить версию в нашем POM-файле с помощью номера сборки Jenkins. Это даст нам возможность отслеживания кода обратно к сборке Jenkins. 
**6** Запустите плагин сонара для выполнения статического анализа кода. 
**7** Создайте архив JAR и WARs в Jenkins. **Записывайте отпечатки пальцев для отслеживания. **
**8** Архивируйте результаты тестирования устройства, чтобы генерировать тенденции. 
**9** Выполните команду развертывания Maven для загрузки наших артефактов (файл POM и WAR) в Nexus. Он будет версироваться по номеру сборки Jenkins, заданному командой Maven set: versions. 
**10** Имитировать автоматическое развертывание серверов разработки. Параллелизм: 1 указывает, что если есть несколько экземпляров этого конвейера, на котором может выполняться только один экземпляр за один раз. Файл WAR будет загружен из Nexus и развернут на серверы приложений в среде разработки. 
**11** Имитировать развертывание в тестовой среде. 
**12** Перед развертыванием в указанную среду появится запрос на ввод. **Параметр submitter указывает пользователю или группе, которым разрешено выполнять этот шаг. ****В этом случае только администратор может развертывать для тестирования или производства.**

### **Создайте Git Hook в Gerrit**

**Примечание.** Вы можете пропустить этот раздел, если используете изображение контейнера

Мы создадим крючок в Gerrit, который автоматически запустит наш конвейер Jenkins, когда код будет успешно проверен экспертом и отправлен в авторитетный репозиторий Git, управляемый Gerrit. Обратите внимание, что он предполагает, что Jenkins login - admin / admin, а имя проекта - CI Demo

**Примечание.** Мы используем Gerrit для управления обзором и продвижением кода, но также могут быть включены другие методы и инструменты. Примером может служить использование рабочего потока Git [*http://nvie.com/posts/a-successful-git-branching-model/*](http://nvie.com/posts/a-successful-git-branching-model/)

Для получения дополнительной информации об объединенном с заменой Gerrit крюке обратитесь к [*https://review.typo3.org/Documentation/config-hooks.html#_change_merged*](https://review.typo3.org/Documentation/config-hooks.html#_change_merged)

```
* \ $  Mkdir  \ $ { CI \ _HOME } / gerrit / hooks
```

```
\ $  Printf  '\ #! / Bin / sh
```

```
Если  \ [ \ $ 8  ==  \ \ "Демо \\"  \ ]; тогда
```

```
Curl  - u  admin : admin
```

```
Http : // localhost: 8083 / job / CI %% 20Demo / build \\? Token = super \ _secret \ _build \ _token
```

```
& Gt ; / Tmp / results . текст
```

```
Fi  '> \ $ {CI \ _HOME} / gerrit / hooks / change-merged
```

```

```

```
\ $  Chmod  555  \ $ { CI \ _HOME } / gerrit / hooks / change - merged *
```

РАЗДЕЛ 8

## Тестирование трубопровода CI

### **Утвердить начальную проверку кода в Gerrit**

\1. Войдите в gerrit ( [*http: // http: // localhost: 8082 / login*](http://http//localhost:8082/login) ) в качестве ведущего пользователя команды

1. Выберите «Все» → «Открыть». Будет ожидающий экспертный обзор с надписью Initial commit
2. Нажмите ссылку «Исходная фиксация»

**1 В** этом разделе перечислены все файлы, которые были изменены и должны быть удалены как часть обзора. При нажатии на файл в списке будет отображаться diff от предыдущей версии файла. Экран diff также позволяет размещать комментарии в строках файла. 
**2** Reply ... позволяет рецензру отправить общую отзыв о наборе изменений. 
**3** Поведение Gerrit по умолчанию требует, чтобы по крайней мере один человек с достаточной привилегией дал голос +2, чтобы изменения могли быть допущены к подаче в авторитетный репозиторий Git. Эта кнопка обеспечивает быстрое средство для этого.

1. Выберите кнопку «Ответить ...»
2. Введите текстовое описание и выберите вариант +2, чтобы код мог быть отправлен в авторитетный репозиторий. Нажмите кнопку «Опубликовать».
3. Обратите внимание, что теперь доступна кнопка «Отправить». Это поместит это изменение в авторитетный репозиторий. Откройте вкладку браузера в демонстрационный проект Jenkins CI ( [*http: // localhost: 8083 / job / CI% 20Demo /*](http://localhost:8083/job/CI%20Demo/) )
4. Теперь нажмите кнопку «Отправить» в Gerrit и вернитесь на вкладку Jenkins. Новая сборка должна начаться в ближайшее время, так как наш сменный крюк будет вызываться Gerrit
5. Если вы наведите указатель мыши на этап «Развертывание до тестирования», вам будет предложено установить его в тестовую среду. Поскольку конвейер позволяет администратору только развернуть, мы можем нажать кнопку «Продолжить». Повторите для производства.

### **Просмотр результатов Nexus и SonarQube**

Убедитесь, что файл WAR был загружен в Nexus:

\1. Войдите в Nexus через [*http: // localhost: 8081 /*](http://localhost:8081/) с помощью admin / admin123

1. Выберите Обзор → Компоненты → maven-релизы

Cisampleapp должен быть виден с соответствующим номером версии. Щелкните по нему, и вы должны увидеть WAR, pom и соответствующие контрольные суммы в репозитории.

Просмотр результатов анализа SonarQube

\1. Войдите в SonarQube через [*http: // localhost: 8084 /*](http://localhost:8084/) с помощью admin / admin

1. Приложение cisample должно быть видимым, щелкните по нему
2. В разделе «Кодовые запахи» отмечается рейтинг C
3. Нажмите C, затем щелкните исходный файл Listener.java
4. Разверните каждый элемент в исходном коде, чтобы выявить запахи кода.
5. Изучите другие области интерфейса SonarQube

### **Обновить код**

Здесь мы разрешаем некоторые запахи кода и выполняем конвейер еще раз. 1. Обновите исходный файл Listener.java, расположенный в $ {GIT_HOME} /Demo/src/main/java/org/example/Listener.java

1. Удалить строку public int thisIsBad = 0;
2. Добавьте примечание @Override над каждым методом

```
Пакет  org . Пример ;
```

```

```

```
Импортировать  javax . Сервлет . ServletContextEvent ;
```

```

```

```
Открытый  класс  Listener  реализует  javax . Сервлет . ServletContextListener {
```

```

```

```
        @Override
```

```
        Public  void  contextDestroyed ( ServletContextEvent  arg0 ) {
```

```
                Система . из . Println ( «Инициализация приложения CI / CD» );
```

```

```

```
        }
```

```

```

```
        @Override
```

```
        Public  void  contextInitialized ( ServletContextEvent  arg0 ) {
```

```
                Система . из . Println ( «Запуск CI / CD» );
```

```

```

```
        }
```

1. Зафиксируйте и нажмите на изменения в Gerrit

`$ git commit -am "Resolved some SonarQube issues" $ git push origin HEAD:refs/for/master*`

### **Утвердить код в Gerrit**

\1. Вернитесь к Gerrit в качестве пользователя команды

1. В настоящее время представлен новый открытый экспертный обзор
2. Щелкните по проблеме, затем щелкните список файлов, чтобы просмотреть diff
3. Комментарии могут быть добавлены в diff, щелкнув номер строки в одном из полей
4. Нажмите кнопку «Назад», чтобы вернуться на предыдущий экран.
5. Нажмите кнопку «Код-обзор + 2», чтобы подтвердить изменение
6. Нажмите кнопку «Отправить», чтобы отправить изменение в авторитетный репозиторий Git. Проверьте, что в Jenkins началась другая сборка.

### **Убедитесь, что у SonarQube меньше проблем**

\1. Войдите в систему SonarQube и обратите внимание на то, что количество запахов кода уменьшилось с пяти до двух

> **Третий путь** Третий путь - это создание культуры, которая способствует двум вещам: постоянному экспериментированию, риску и обучению от неудачи; И понимание того, что повторение и практика являются предпосылкой для овладения.

> \- Джин Ким Три способа: принципы, лежащие в основе DevOps

Разработчики должны иметь возможность быстро создавать производственные среды для развертывания и экспериментов с изменениями кода и приложений. Эта возможность, которая обеспечивает третий способ, облегчается посредством платформы как службы (PaaS) с использованием таких инструментов, как Red Hat® OpenShift Container Platform (OCP) [*https://www.openshift.com/container-platform/*](https://www.openshift.com/container-platform/)

РАЗДЕЛ 9

## инструменты

Ниже приведена выборка инструментов, доступных для поддержки ваших усилий по непрерывной интеграции.

| **Тип инструмента**                      | **имя**                                  |
| ---------------------------------------- | ---------------------------------------- |
| CI / CD-сервер                           | Jenkins / Hudson, Bamboo, TravisCI, GitLab CI |
| Статический анализ качества кода         | Findbugs, PMD, CheckStyle                |
| Автоматизированное тестирование          | Юнит, Селен, Огурцы                      |
| Инструменты сборки                       | Maven, Gradle, Ant, Buildr, Rake         |
| Репозиторий артефактов                   | Nexus, Artifactory                       |
| Отчетность и агрегирование качества кода | SonarQube                                |
| Контроль версий                          | Git, Subversion, Mercurial               |
| Обзор кода                               | Gerrit, Crucible, Git Lab, Phabricator   |

*1* . Три способа: принципы, лежащие в основе DevOps, Gene Kim - [*http://itrevolution.com/the-three-ways-principles-underpinning-devops/*](http://itrevolution.com/the-three-ways-principles-underpinning-devops/)